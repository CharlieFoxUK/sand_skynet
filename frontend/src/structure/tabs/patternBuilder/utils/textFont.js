/**
 * Pattern Builder - Text Font Data
 * 
 * Single-stroke (line) font for sand table text drawing.
 * Each character is defined as an array of strokes.
 * Each stroke is an array of [x, y] points normalized to a 0-1 unit square.
 * Characters are approximately 0.6 wide and 1.0 tall.
 */

// Simple single-stroke font - each character is an array of strokes (polylines)
// Format: { char: [[stroke1], [stroke2], ...] } where each stroke is [[x,y], [x,y], ...]
const STROKE_FONT = {
    'A': [[[0, 0], [0.3, 1], [0.6, 0]], [[0.1, 0.4], [0.5, 0.4]]],
    'B': [[[0, 0], [0, 1], [0.4, 1], [0.5, 0.9], [0.5, 0.6], [0.4, 0.5], [0, 0.5]], [[0, 0.5], [0.45, 0.5], [0.55, 0.4], [0.55, 0.1], [0.45, 0], [0, 0]]],
    'C': [[[0.5, 0.2], [0.4, 0.05], [0.2, 0], [0.1, 0.1], [0, 0.3], [0, 0.7], [0.1, 0.9], [0.2, 1], [0.4, 0.95], [0.5, 0.8]]],
    'D': [[[0, 0], [0, 1], [0.3, 1], [0.5, 0.9], [0.55, 0.7], [0.55, 0.3], [0.5, 0.1], [0.3, 0], [0, 0]]],
    'E': [[[0.5, 0], [0, 0], [0, 1], [0.5, 1]], [[0, 0.5], [0.4, 0.5]]],
    'F': [[[0, 0], [0, 1], [0.5, 1]], [[0, 0.5], [0.4, 0.5]]],
    'G': [[[0.5, 0.8], [0.4, 0.95], [0.2, 1], [0.1, 0.9], [0, 0.7], [0, 0.3], [0.1, 0.1], [0.2, 0], [0.4, 0.05], [0.5, 0.2], [0.5, 0.5], [0.3, 0.5]]],
    'H': [[[0, 0], [0, 1]], [[0.5, 0], [0.5, 1]], [[0, 0.5], [0.5, 0.5]]],
    'I': [[[0.1, 0], [0.4, 0]], [[0.25, 0], [0.25, 1]], [[0.1, 1], [0.4, 1]]],
    'J': [[[0.1, 0.2], [0.2, 0.05], [0.3, 0], [0.4, 0.05], [0.5, 0.2], [0.5, 1]]],
    'K': [[[0, 0], [0, 1]], [[0.5, 1], [0, 0.4], [0.5, 0]]],
    'L': [[[0, 1], [0, 0], [0.5, 0]]],
    'M': [[[0, 0], [0, 1], [0.25, 0.5], [0.5, 1], [0.5, 0]]],
    'N': [[[0, 0], [0, 1], [0.5, 0], [0.5, 1]]],
    'O': [[[0.25, 0], [0.1, 0.1], [0, 0.3], [0, 0.7], [0.1, 0.9], [0.25, 1], [0.35, 1], [0.5, 0.9], [0.6, 0.7], [0.6, 0.3], [0.5, 0.1], [0.35, 0], [0.25, 0]]],
    'P': [[[0, 0], [0, 1], [0.4, 1], [0.5, 0.9], [0.5, 0.6], [0.4, 0.5], [0, 0.5]]],
    'Q': [[[0.25, 0], [0.1, 0.1], [0, 0.3], [0, 0.7], [0.1, 0.9], [0.25, 1], [0.35, 1], [0.5, 0.9], [0.6, 0.7], [0.6, 0.3], [0.5, 0.1], [0.35, 0], [0.25, 0]], [[0.4, 0.2], [0.6, 0]]],
    'R': [[[0, 0], [0, 1], [0.4, 1], [0.5, 0.9], [0.5, 0.6], [0.4, 0.5], [0, 0.5]], [[0.25, 0.5], [0.5, 0]]],
    'S': [[[0.5, 0.85], [0.4, 1], [0.1, 1], [0, 0.85], [0, 0.65], [0.1, 0.55], [0.4, 0.45], [0.5, 0.35], [0.5, 0.15], [0.4, 0], [0.1, 0], [0, 0.15]]],
    'T': [[[0, 1], [0.6, 1]], [[0.3, 1], [0.3, 0]]],
    'U': [[[0, 1], [0, 0.2], [0.1, 0.05], [0.25, 0], [0.35, 0.05], [0.5, 0.2], [0.5, 1]]],
    'V': [[[0, 1], [0.3, 0], [0.6, 1]]],
    'W': [[[0, 1], [0.15, 0], [0.3, 0.5], [0.45, 0], [0.6, 1]]],
    'X': [[[0, 0], [0.5, 1]], [[0, 1], [0.5, 0]]],
    'Y': [[[0, 1], [0.25, 0.5], [0.5, 1]], [[0.25, 0.5], [0.25, 0]]],
    'Z': [[[0, 1], [0.5, 1], [0, 0], [0.5, 0]]],

    // Numbers
    '0': [[[0.25, 0], [0.1, 0.1], [0, 0.3], [0, 0.7], [0.1, 0.9], [0.25, 1], [0.35, 1], [0.5, 0.9], [0.6, 0.7], [0.6, 0.3], [0.5, 0.1], [0.35, 0], [0.25, 0]], [[0.1, 0.2], [0.5, 0.8]]],
    '1': [[[0.15, 0.8], [0.3, 1], [0.3, 0]], [[0.1, 0], [0.5, 0]]],
    '2': [[[0, 0.85], [0.1, 1], [0.4, 1], [0.5, 0.85], [0.5, 0.65], [0, 0], [0.5, 0]]],
    '3': [[[0, 0.85], [0.15, 1], [0.35, 1], [0.5, 0.85], [0.5, 0.6], [0.3, 0.5], [0.5, 0.4], [0.5, 0.15], [0.35, 0], [0.15, 0], [0, 0.15]]],
    '4': [[[0, 1], [0, 0.4], [0.5, 0.4]], [[0.4, 1], [0.4, 0]]],
    '5': [[[0.5, 1], [0, 1], [0, 0.5], [0.4, 0.5], [0.5, 0.4], [0.5, 0.1], [0.4, 0], [0, 0]]],
    '6': [[[0.4, 1], [0.2, 1], [0.05, 0.8], [0, 0.3], [0.1, 0.05], [0.3, 0], [0.45, 0.1], [0.5, 0.3], [0.45, 0.5], [0.3, 0.55], [0.1, 0.5], [0, 0.3]]],
    '7': [[[0, 1], [0.5, 1], [0.2, 0]]],
    '8': [[[0.25, 0.5], [0.1, 0.55], [0, 0.7], [0, 0.85], [0.1, 1], [0.4, 1], [0.5, 0.85], [0.5, 0.7], [0.4, 0.55], [0.25, 0.5], [0.1, 0.45], [0, 0.3], [0, 0.15], [0.1, 0], [0.4, 0], [0.5, 0.15], [0.5, 0.3], [0.4, 0.45], [0.25, 0.5]]],
    '9': [[[0.1, 0], [0.3, 0], [0.45, 0.2], [0.5, 0.7], [0.4, 0.95], [0.2, 1], [0.05, 0.9], [0, 0.7], [0.05, 0.5], [0.2, 0.45], [0.4, 0.5], [0.5, 0.7]]],

    // Punctuation
    ' ': [],
    '.': [[[0.2, 0.1], [0.3, 0.1], [0.3, 0], [0.2, 0], [0.2, 0.1]]],
    ',': [[[0.25, 0.15], [0.25, 0], [0.15, -0.1]]],
    '!': [[[0.25, 1], [0.25, 0.3]], [[0.25, 0.1], [0.25, 0]]],
    '?': [[[0, 0.8], [0.1, 1], [0.4, 1], [0.5, 0.8], [0.5, 0.6], [0.25, 0.4], [0.25, 0.25]], [[0.25, 0.1], [0.25, 0]]],
    '-': [[[0.1, 0.5], [0.5, 0.5]]],
    '_': [[[0, 0], [0.6, 0]]],
    ':': [[[0.25, 0.7], [0.25, 0.6]], [[0.25, 0.3], [0.25, 0.2]]],
    ';': [[[0.25, 0.7], [0.25, 0.6]], [[0.25, 0.3], [0.25, 0.2], [0.15, 0.1]]],
    "'": [[[0.25, 1], [0.25, 0.8]]],
    '"': [[[0.15, 1], [0.15, 0.8]], [[0.35, 1], [0.35, 0.8]]],
    '/': [[[0, 0], [0.5, 1]]],
    '\\': [[[0, 1], [0.5, 0]]],
    '(': [[[0.35, 1], [0.2, 0.8], [0.1, 0.5], [0.2, 0.2], [0.35, 0]]],
    ')': [[[0.15, 1], [0.3, 0.8], [0.4, 0.5], [0.3, 0.2], [0.15, 0]]],
    '[': [[[0.35, 1], [0.15, 1], [0.15, 0], [0.35, 0]]],
    ']': [[[0.15, 1], [0.35, 1], [0.35, 0], [0.15, 0]]],
    '+': [[[0, 0.5], [0.5, 0.5]], [[0.25, 0.25], [0.25, 0.75]]],
    '=': [[[0.05, 0.6], [0.55, 0.6]], [[0.05, 0.4], [0.55, 0.4]]],
    '*': [[[0.25, 0.3], [0.25, 0.7]], [[0.1, 0.4], [0.4, 0.6]], [[0.1, 0.6], [0.4, 0.4]]],
    '#': [[[0.15, 0.2], [0.15, 0.8]], [[0.35, 0.2], [0.35, 0.8]], [[0.05, 0.35], [0.45, 0.35]], [[0.05, 0.65], [0.45, 0.65]]],
    '@': [[[0.4, 0.4], [0.35, 0.35], [0.25, 0.35], [0.2, 0.4], [0.2, 0.55], [0.25, 0.6], [0.4, 0.6], [0.45, 0.5], [0.45, 0.2], [0.35, 0.05], [0.15, 0], [0.05, 0.15], [0, 0.5], [0.05, 0.85], [0.2, 1], [0.45, 0.95], [0.55, 0.75]]],
    '&': [[[0.5, 0.15], [0.25, 0], [0.1, 0.1], [0.1, 0.3], [0.5, 0.7], [0.5, 0.85], [0.4, 1], [0.2, 1], [0.1, 0.85], [0.1, 0.7], [0.4, 0.3], [0.5, 0]]],

    // Lowercase (simplified, based on uppercase)
    'a': [[[0.45, 0.6], [0.35, 0.65], [0.15, 0.65], [0.05, 0.55], [0.05, 0.15], [0.15, 0], [0.35, 0], [0.45, 0.1], [0.45, 0.65], [0.45, 0]]],
    'b': [[[0, 1], [0, 0], [0.35, 0], [0.45, 0.1], [0.45, 0.55], [0.35, 0.65], [0, 0.65]]],
    'c': [[[0.45, 0.55], [0.35, 0.65], [0.15, 0.65], [0.05, 0.55], [0.05, 0.1], [0.15, 0], [0.35, 0], [0.45, 0.1]]],
    'd': [[[0.45, 1], [0.45, 0], [0.1, 0], [0, 0.1], [0, 0.55], [0.1, 0.65], [0.45, 0.65]]],
    'e': [[[0.05, 0.35], [0.45, 0.35], [0.45, 0.55], [0.35, 0.65], [0.15, 0.65], [0.05, 0.55], [0.05, 0.1], [0.15, 0], [0.35, 0], [0.45, 0.1]]],
    'f': [[[0.15, 0], [0.15, 0.9], [0.25, 1], [0.4, 1]], [[0.05, 0.65], [0.35, 0.65]]],
    'g': [[[0.45, 0.65], [0.1, 0.65], [0, 0.55], [0, 0.1], [0.1, 0], [0.45, 0], [0.45, 0.65], [0.45, -0.2], [0.3, -0.3], [0.1, -0.25]]],
    'h': [[[0, 1], [0, 0]], [[0, 0.5], [0.35, 0.65], [0.45, 0.55], [0.45, 0]]],
    'i': [[[0.2, 0], [0.2, 0.55]], [[0.2, 0.75], [0.2, 0.8]]],
    'j': [[[0.25, 0.65], [0.25, 0], [0.15, -0.15], [0.05, -0.15]], [[0.25, 0.8], [0.25, 0.85]]],
    'k': [[[0, 1], [0, 0]], [[0.4, 0.65], [0, 0.3], [0.4, 0]]],
    'l': [[[0.2, 1], [0.2, 0.1], [0.3, 0]]],
    'm': [[[0, 0], [0, 0.65], [0.1, 0.65], [0.2, 0.55], [0.2, 0], [0.3, 0.65], [0.4, 0.65], [0.5, 0.55], [0.5, 0]]],
    'n': [[[0, 0], [0, 0.65], [0.1, 0.65], [0.35, 0.65], [0.45, 0.55], [0.45, 0]]],
    'o': [[[0.25, 0], [0.1, 0.05], [0, 0.2], [0, 0.45], [0.1, 0.6], [0.25, 0.65], [0.35, 0.65], [0.5, 0.6], [0.55, 0.45], [0.55, 0.2], [0.5, 0.05], [0.35, 0], [0.25, 0]]],
    'p': [[[0, 0.65], [0, -0.3]], [[0, 0.55], [0.1, 0.65], [0.35, 0.65], [0.45, 0.55], [0.45, 0.1], [0.35, 0], [0, 0]]],
    'q': [[[0.45, 0.65], [0.45, -0.3]], [[0.45, 0.55], [0.35, 0.65], [0.1, 0.65], [0, 0.55], [0, 0.1], [0.1, 0], [0.45, 0]]],
    'r': [[[0.05, 0], [0.05, 0.65]], [[0.05, 0.45], [0.15, 0.6], [0.3, 0.65], [0.45, 0.6]]],
    's': [[[0.4, 0.55], [0.3, 0.65], [0.1, 0.65], [0, 0.55], [0, 0.45], [0.1, 0.35], [0.3, 0.3], [0.4, 0.2], [0.4, 0.1], [0.3, 0], [0.1, 0], [0, 0.1]]],
    't': [[[0.2, 1], [0.2, 0.1], [0.3, 0]], [[0.05, 0.65], [0.35, 0.65]]],
    'u': [[[0, 0.65], [0, 0.15], [0.1, 0], [0.35, 0], [0.45, 0.15], [0.45, 0.65], [0.45, 0]]],
    'v': [[[0, 0.65], [0.25, 0], [0.5, 0.65]]],
    'w': [[[0, 0.65], [0.1, 0], [0.25, 0.4], [0.4, 0], [0.5, 0.65]]],
    'x': [[[0, 0], [0.45, 0.65]], [[0, 0.65], [0.45, 0]]],
    'y': [[[0, 0.65], [0.25, 0.25], [0.5, 0.65]], [[0.25, 0.25], [0.15, -0.25], [0, -0.25]]],
    'z': [[[0, 0.65], [0.45, 0.65], [0, 0], [0.45, 0]]],
};

// Character width lookup (most are 0.6, some are different)
const CHAR_WIDTHS = {
    'I': 0.5,
    'i': 0.4,
    'l': 0.35,
    'j': 0.35,
    ' ': 0.4,
    '.': 0.3,
    ',': 0.3,
    ':': 0.3,
    ';': 0.3,
    "'": 0.3,
    '!': 0.35,
    'M': 0.7,
    'W': 0.7,
    'm': 0.65,
    'w': 0.6,
};

/**
 * Get the width of a character
 */
function getCharWidth(char) {
    return CHAR_WIDTHS[char] || 0.6;
}

/**
 * Convert text to an array of stroke paths
 * @param {string} text - Text to convert
 * @param {number} fontSize - Font size (height of characters)
 * @param {number} letterSpacing - Extra spacing between letters
 * @returns {Array<Array<{x: number, y: number}>>} - Array of stroke paths
 */
export function textToStrokes(text, fontSize = 1, letterSpacing = 0.1) {
    const strokes = [];
    let cursorX = 0;
    const lineHeight = fontSize * 1.3;
    let cursorY = 0;

    const lines = text.split('\n');

    for (const line of lines) {
        cursorX = 0;

        for (const char of line) {
            const charDef = STROKE_FONT[char] || STROKE_FONT[char.toUpperCase()] || [];
            const charWidth = getCharWidth(char) * fontSize;

            // Add each stroke of this character
            for (const stroke of charDef) {
                if (stroke.length > 0) {
                    const transformedStroke = stroke.map(([x, y]) => ({
                        x: cursorX + x * fontSize,
                        y: cursorY + y * fontSize
                    }));
                    strokes.push(transformedStroke);
                }
            }

            cursorX += charWidth + letterSpacing * fontSize;
        }

        cursorY -= lineHeight;
    }

    return strokes;
}

/**
 * Get the total width and height of text
 */
export function getTextDimensions(text, fontSize = 1, letterSpacing = 0.1) {
    const lines = text.split('\n');
    let maxWidth = 0;

    for (const line of lines) {
        let lineWidth = 0;
        for (const char of line) {
            lineWidth += (getCharWidth(char) + letterSpacing) * fontSize;
        }
        lineWidth -= letterSpacing * fontSize; // Remove last spacing
        maxWidth = Math.max(maxWidth, lineWidth);
    }

    const height = lines.length * fontSize * 1.3;

    return { width: maxWidth, height };
}

/**
 * Generate points for text, converting all strokes to a single continuous path
 * with travel moves (pen-up connections)
 */
export function generateTextPoints(text, fontSize = 0.3, letterSpacing = 0.05, centerX = 0, centerY = 0) {
    const strokes = textToStrokes(text, fontSize, letterSpacing);

    if (strokes.length === 0) return [];

    // Get dimensions for centering
    const dims = getTextDimensions(text, fontSize, letterSpacing);
    const offsetX = centerX - dims.width / 2;
    const offsetY = centerY + dims.height / 2 - fontSize;

    // Combine all strokes into one path, with the understanding that
    // the gcode generator will need to handle "pen up" moves between strokes
    const allPoints = [];

    for (const stroke of strokes) {
        for (const point of stroke) {
            allPoints.push({
                x: point.x + offsetX,
                y: point.y + offsetY
            });
        }
        // Add a marker for stroke break (handled in gcode generation)
        if (stroke.length > 0) {
            allPoints.push({ x: NaN, y: NaN, isBreak: true });
        }
    }

    // Remove last break marker
    if (allPoints.length > 0 && allPoints[allPoints.length - 1].isBreak) {
        allPoints.pop();
    }

    return allPoints;
}

export default STROKE_FONT;
